name: 02_3_Canary Security Scan

on:
  push:
    branches: [release]

env:
  REGISTRY: ghcr.io

jobs:
  ZAP_Security_Scan:
    name: ğŸ›¡ï¸ ZAP Security Validation
    runs-on: ubuntu-latest
    environment: canary

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â³ Wait for Canary Stability
        run: |
          echo "â³ Attente stabilisation environnement canary..."
          sleep 60
          
          # VÃ©rifier que le canary rÃ©pond
          for i in {1..5}; do
            if curl -f -m 10 http://${{ secrets.CANARY_HOST }}/; then
              echo "âœ… Frontend stable (tentative $i)"
              break
            else
              echo "â³ Frontend pas encore stable (tentative $i/5)"
              if [ $i -eq 5 ]; then
                echo "âŒ Frontend non stable aprÃ¨s 5 tentatives"
                exit 1
              fi
              sleep 15
            fi
          done
          
          # VÃ©rifier que l'API rÃ©pond
          for i in {1..5}; do
            if curl -f -m 10 http://${{ secrets.CANARY_HOST }}:3000/health; then
              echo "âœ… API stable (tentative $i)"
              break
            else
              echo "â³ API pas encore stable (tentative $i/5)"
              if [ $i -eq 5 ]; then
                echo "âŒ API non stable aprÃ¨s 5 tentatives"
                exit 1
              fi
              sleep 15
            fi
          done

      - name: ğŸ›¡ï¸ ZAP Baseline Scan - Frontend
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://${{ secrets.CANARY_HOST }}'
          fail_action: true
          artifact_name: 'zap_baseline_frontend'
          issue_title: 'ZAP Frontend Security Report - Release Validation'

      - name: ğŸ›¡ï¸ ZAP Baseline Scan - API
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://${{ secrets.CANARY_HOST }}:3000'
          fail_action: true
          artifact_name: 'zap_baseline_api'
          issue_title: 'ZAP API Security Report - Release Validation'

      - name: ğŸ›¡ï¸ API Security Tests
        run: |
          echo "ğŸ” Tests sÃ©curitÃ© API..."
          
          # Test endpoint API health
          API_RESPONSE=$(curl -s -w "%{http_code}" http://${{ secrets.CANARY_HOST }}:3000/health -o /dev/null)
          if [ "$API_RESPONSE" = "200" ]; then
            echo "âœ… API health endpoint accessible"
          else
            echo "âŒ API health endpoint non accessible (code: $API_RESPONSE)"
            exit 1
          fi
          
          # Test que la base de donnÃ©es n'est pas accessible
          if nc -z -v -w5 ${{ secrets.CANARY_HOST }} 3306 2>/dev/null; then
            echo "âŒ CRITIQUE: Base de donnÃ©es accessible directement!"
            exit 1
          else
            echo "âœ… SÃ‰CURITÃ‰: Base de donnÃ©es non accessible directement"
          fi

      - name: ğŸ”’ Basic Security Validation
        run: |
          echo "ğŸ”’ Validation sÃ©curitÃ© de base..."
          
          # Test headers de sÃ©curitÃ© frontend
          FRONTEND_HEADERS=$(curl -s -I http://${{ secrets.CANARY_HOST }}/)
          echo "Headers frontend reÃ§us:"
          echo "$FRONTEND_HEADERS"
          
          # Test headers de sÃ©curitÃ© API
          API_HEADERS=$(curl -s -I http://${{ secrets.CANARY_HOST }}:3000/health)
          echo "Headers API reÃ§us:"
          echo "$API_HEADERS"

      - name: ğŸ¯ Application Security Tests
        run: |
          echo "ğŸ§ª Tests sÃ©curitÃ© applicatifs..."
          
          # Test que les endpoints sensibles ne sont pas exposÃ©s
          SENSITIVE_ENDPOINTS=("/admin" "/config" "/debug" "/.env")
          
          for endpoint in "${SENSITIVE_ENDPOINTS[@]}"; do
            RESPONSE=$(curl -s -w "%{http_code}" http://${{ secrets.CANARY_HOST }}${endpoint} -o /dev/null)
            if [ "$RESPONSE" = "404" ] || [ "$RESPONSE" = "403" ]; then
              echo "âœ… Endpoint ${endpoint} correctement protÃ©gÃ© (${RESPONSE})"
            else
              echo "âš ï¸  Endpoint ${endpoint} rÃ©pond avec code: ${RESPONSE}"
            fi
          done

      - name: ğŸ›¡ï¸ ZAP Full Scan (Si baseline OK)
        uses: zaproxy/action-full-scan@v0.9.0
        continue-on-error: true
        with:
          target: 'http://${{ secrets.CANARY_HOST }}'
          fail_action: false
          artifact_name: 'zap_full_scan'
          issue_title: 'ZAP Full Security Report - Release Validation'

  Security_Summary:
    name: ğŸ“‹ Security Validation Summary
    needs: [ZAP_Security_Scan]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“Š RÃ©sumÃ© Validation SÃ©curitÃ©
        run: |
          echo "ğŸ›¡ï¸ VALIDATION SÃ‰CURITÃ‰ CANARY - RÃ©sumÃ©:"
          echo "  ğŸ” ZAP Security Scan: ${{ needs.ZAP_Security_Scan.result }}"
          
          if [[ "${{ needs.ZAP_Security_Scan.result }}" == "success" ]]; then
            echo ""
            echo "âœ… VALIDATION SÃ‰CURITÃ‰ RÃ‰USSIE!"
            echo "ğŸ›¡ï¸ Environnement canary sÃ©curisÃ© et validÃ©"
            echo "ğŸš€ PRÃŠT POUR DÃ‰PLOIEMENT PRODUCTION"
            echo ""
            echo "ğŸ“‹ Actions suivantes:"
            echo "  1. Merger cette release vers main"
            echo "  2. DÃ©clencher dÃ©ploiement production"
            echo "  3. Monitorer dÃ©ploiement prod"
          else
            echo ""
            echo "âŒ VALIDATION SÃ‰CURITÃ‰ Ã‰CHOUÃ‰E"
            echo "ğŸš¨ DÃ‰PLOIEMENT PRODUCTION BLOQUÃ‰"
            echo ""
            echo "ğŸ”§ Actions requises:"
            echo "  1. Analyser les rapports ZAP"
            echo "  2. Corriger les vulnÃ©rabilitÃ©s"
            echo "  3. CrÃ©er nouvelle PR develop â†’ release"
            echo "  4. Re-tester avant production"
            exit 1
          fi

      - name: ğŸ”” Notification Status
        run: |
          echo "ğŸ“¢ Notification: Validation sÃ©curitÃ© terminÃ©e"
          echo "ğŸ¯ Statut: ${{ needs.ZAP_Security_Scan.result }}"
          echo "ğŸ“… Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          # Ici vous pourriez ajouter des notifications Slack/Discord/Email