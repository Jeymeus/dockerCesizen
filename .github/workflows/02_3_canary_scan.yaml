name: 02_3_Canary Security Scan

on:
  push:
    branches: [release]

env:
  REGISTRY: ghcr.io

jobs:
  ZAP_Security_Scan:
    name: ğŸ›¡ï¸ ZAP Security Validation
    runs-on: ubuntu-latest
    environment: canary

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â³ Wait for Canary Stability
        run: |
          echo "â³ Attente stabilisation environnement canary..."
          sleep 60
          
          # VÃ©rifier que le canary rÃ©pond
          for i in {1..5}; do
            if curl -f -m 10 http://${{ secrets.CANARY_HOST }}/health; then
              echo "âœ… Canary stable (tentative $i)"
              break
            else
              echo "â³ Canary pas encore stable (tentative $i/5)"
              if [ $i -eq 5 ]; then
                echo "âŒ Canary non stable aprÃ¨s 5 tentatives"
                exit 1
              fi
              sleep 15
            fi
          done

      - name: ğŸ›¡ï¸ ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://${{ secrets.CANARY_HOST }}'
          fail_action: true
          artifact_name: 'zap_baseline_scan'
          issue_title: 'ZAP Baseline Security Report - Release Validation'

      - name: ğŸ›¡ï¸ ZAP API Security Test
        run: |
          echo "ğŸ” Tests sÃ©curitÃ© spÃ©cifiques API..."
          
          # Test endpoint API via proxy
          API_RESPONSE=$(curl -s -w "%{http_code}" http://${{ secrets.CANARY_HOST }}/api/health -o /dev/null)
          if [ "$API_RESPONSE" = "200" ]; then
            echo "âœ… API endpoint accessible via proxy"
          else
            echo "âŒ API endpoint non accessible via proxy (code: $API_RESPONSE)"
            exit 1
          fi
          
          # VÃ©rifier que l'API directe n'est toujours PAS accessible
          if curl -f -m 5 http://${{ secrets.CANARY_HOST }}:3000/ 2>/dev/null; then
            echo "âŒ CRITIQUE: API accessible directement - Faille sÃ©curitÃ© majeure!"
            exit 1
          else
            echo "âœ… SÃ‰CURITÃ‰: API non accessible directement"
          fi

      - name: ğŸ”’ Advanced Security Validation
        run: |
          echo "ğŸ”’ Validation sÃ©curitÃ© avancÃ©e..."
          
          # Test headers de sÃ©curitÃ©
          SECURITY_HEADERS=$(curl -s -I http://${{ secrets.CANARY_HOST }}/)
          
          # VÃ©rifier CSP
          if echo "$SECURITY_HEADERS" | grep -i "content-security-policy"; then
            echo "âœ… Content Security Policy prÃ©sent"
          else
            echo "âŒ Content Security Policy manquant"
            exit 1
          fi
          
          # VÃ©rifier X-Frame-Options
          if echo "$SECURITY_HEADERS" | grep -i "x-frame-options"; then
            echo "âœ… X-Frame-Options prÃ©sent"
          else
            echo "âŒ X-Frame-Options manquant"
            exit 1
          fi
          
          # VÃ©rifier X-Content-Type-Options
          if echo "$SECURITY_HEADERS" | grep -i "x-content-type-options"; then
            echo "âœ… X-Content-Type-Options prÃ©sent"
          else
            echo "âŒ X-Content-Type-Options manquant"
            exit 1
          fi

      - name: ğŸ¯ Application Security Tests
        run: |
          echo "ğŸ§ª Tests sÃ©curitÃ© applicatifs..."
          
          # Test route /admin bloquÃ©e
          ADMIN_RESPONSE=$(curl -s -w "%{http_code}" http://${{ secrets.CANARY_HOST }}/admin -o /dev/null)
          if [ "$ADMIN_RESPONSE" = "403" ]; then
            echo "âœ… Route /admin correctement bloquÃ©e"
          else
            echo "âŒ Route /admin non bloquÃ©e (code: $ADMIN_RESPONSE)"
            exit 1
          fi
          
          # Test robots.txt
          ROBOTS_RESPONSE=$(curl -s -w "%{http_code}" http://${{ secrets.CANARY_HOST }}/robots.txt -o /dev/null)
          if [ "$ROBOTS_RESPONSE" = "200" ]; then
            echo "âœ… robots.txt accessible"
          else
            echo "âš ï¸  robots.txt non accessible (code: $ROBOTS_RESPONSE)"
          fi

      - name: ğŸ›¡ï¸ ZAP Full Scan (Si baseline OK)
        uses: zaproxy/action-full-scan@v0.9.0
        continue-on-error: true
        with:
          target: 'http://${{ secrets.CANARY_HOST }}'
          fail_action: false
          artifact_name: 'zap_full_scan'
          issue_title: 'ZAP Full Security Report - Release Validation'

  Security_Summary:
    name: ğŸ“‹ Security Validation Summary
    needs: [ZAP_Security_Scan]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“Š RÃ©sumÃ© Validation SÃ©curitÃ©
        run: |
          echo "ğŸ›¡ï¸ VALIDATION SÃ‰CURITÃ‰ CANARY - RÃ©sumÃ©:"
          echo "  ğŸ” ZAP Security Scan: ${{ needs.ZAP_Security_Scan.result }}"
          
          if [[ "${{ needs.ZAP_Security_Scan.result }}" == "success" ]]; then
            echo ""
            echo "âœ… VALIDATION SÃ‰CURITÃ‰ RÃ‰USSIE!"
            echo "ğŸ›¡ï¸ Environnement canary sÃ©curisÃ© et validÃ©"
            echo "ğŸš€ PRÃŠT POUR DÃ‰PLOIEMENT PRODUCTION"
            echo ""
            echo "ğŸ“‹ Actions suivantes:"
            echo "  1. Merger cette release vers main"
            echo "  2. DÃ©clencher dÃ©ploiement production"
            echo "  3. Monitorer dÃ©ploiement prod"
          else
            echo ""
            echo "âŒ VALIDATION SÃ‰CURITÃ‰ Ã‰CHOUÃ‰E"
            echo "ğŸš¨ DÃ‰PLOIEMENT PRODUCTION BLOQUÃ‰"
            echo ""
            echo "ğŸ”§ Actions requises:"
            echo "  1. Analyser les rapports ZAP"
            echo "  2. Corriger les vulnÃ©rabilitÃ©s"
            echo "  3. CrÃ©er nouvelle PR develop â†’ release"
            echo "  4. Re-tester avant production"
            exit 1
          fi

      - name: ğŸ”” Notification Status
        run: |
          echo "ğŸ“¢ Notification: Validation sÃ©curitÃ© terminÃ©e"
          echo "ğŸ¯ Statut: ${{ needs.ZAP_Security_Scan.result }}"
          echo "ğŸ“… Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          # Ici vous pourriez ajouter des notifications Slack/Discord/Email