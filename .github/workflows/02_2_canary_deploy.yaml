name: 02_2_Canary Deploy

on:
  pull_request:
    branches: [release]

env:
  REGISTRY: ghcr.io

jobs:
  Deploy_Canary:
    name: ğŸš€ Deploy to Canary
    runs-on: ubuntu-latest
    environment: canary
    outputs:
      api_image: ${{ steps.image_info.outputs.api_image }}
      frontend_image: ${{ steps.image_info.outputs.frontend_image }}
      deployed_sha: ${{ steps.image_info.outputs.deployed_sha }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“ Get PR info
        run: |
          echo "IMAGE_NAME_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}
          # SHA de la PR = HEAD de develop
          DEVELOP_SHA=${{ github.event.pull_request.head.sha }}
          echo "DEVELOP_SHA=${DEVELOP_SHA}" >> ${GITHUB_ENV}
          echo "ğŸ” DÃ©ploiement canary du SHA: ${DEVELOP_SHA}"

      - name: ğŸ” VÃ©rifier que les images existent
        run: |
          echo ${{ secrets.DCKCESIZEN_PAT }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # VÃ©rifier API image
          if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}-api:canary-${{ env.DEVELOP_SHA }} >/dev/null 2>&1; then
            echo "âœ… Image API trouvÃ©e: canary-${{ env.DEVELOP_SHA }}"
          else
            echo "âŒ Image API manquante: canary-${{ env.DEVELOP_SHA }}"
            echo "ğŸ’¡ VÃ©rifiez que le build sur develop a bien fonctionnÃ©"
            exit 1
          fi
          
          # VÃ©rifier Frontend image
          if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}-frontend:canary-${{ env.DEVELOP_SHA }} >/dev/null 2>&1; then
            echo "âœ… Image Frontend trouvÃ©e: canary-${{ env.DEVELOP_SHA }}"
          else
            echo "âŒ Image Frontend manquante: canary-${{ env.DEVELOP_SHA }}"
            exit 1
          fi

      - name: ğŸ“¤ Upload configs
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.CANARY_HOST }}
          port: 22
          username: ${{ secrets.CANARY_USERNAME }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          source: "./docker-compose.canary.yml,./api/database/init.sql,./frontend/nginx.conf"
          target: "/opt/cesizen/"

      - name: ğŸš€ Deploy Pre-built Images
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CANARY_HOST }}
          port: 22
          username: ${{ secrets.CANARY_USERNAME }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          script: |
            cd /opt/cesizen
            
            # Create directory if needed
            sudo mkdir -p /opt/cesizen
            sudo chown ${{ secrets.CANARY_USERNAME }}:${{ secrets.CANARY_USERNAME }} /opt/cesizen
            
            # Login to GitHub Container Registry
            echo ${{ secrets.DCKCESIZEN_PAT }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull les images spÃ©cifiques au SHA
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}-api:canary-${{ env.DEVELOP_SHA }}
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}-frontend:canary-${{ env.DEVELOP_SHA }}
            
            # CrÃ©er docker-compose avec les bonnes images
            sed "s/:canary/:canary-${{ env.DEVELOP_SHA }}/g" docker-compose.canary.yml > docker-compose.deploy.yml
            
            # Create environment file
            cat > .env << EOF
            NODE_ENV=production
            DB_HOST=mariadb
            DB_USER=cesi
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=cesizen
            DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            PORT=3000
            VITE_API_URL=/api
            DEPLOYED_SHA=${{ env.DEVELOP_SHA }}
            DEPLOYED_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            EOF
            
            # Deploy avec les images prÃ©-buildÃ©es
            docker compose -f docker-compose.deploy.yml down --remove-orphans || true
            docker compose -f docker-compose.deploy.yml up -d
            
            echo "âœ… DÃ©ploiement canary terminÃ©!"
            echo "ğŸ“¦ Images: canary-${{ env.DEVELOP_SHA }}"

      - name: ğŸ“ Export Image Info
        id: image_info
        run: |
          echo "api_image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}-api:canary-${{ env.DEVELOP_SHA }}" >> $GITHUB_OUTPUT
          echo "frontend_image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}-frontend:canary-${{ env.DEVELOP_SHA }}" >> $GITHUB_OUTPUT
          echo "deployed_sha=${{ env.DEVELOP_SHA }}" >> $GITHUB_OUTPUT

  Infrastructure_Validation:
    name: ğŸ”§ Validate Canary Infrastructure
    needs: [Deploy_Canary]
    runs-on: ubuntu-latest

    steps:
      - name: â³ Wait for services
        run: |
          echo "â³ Attente dÃ©marrage des services..."
          sleep 45

      - name: ğŸ¥ Health Check
        run: |
          echo "ğŸ¥ VÃ©rification health check..."
          if curl -f -m 10 http://${{ secrets.CANARY_HOST }}/health; then
            echo "âœ… Health check OK"
          else
            echo "âŒ Health check Ã©chouÃ©"
            exit 1
          fi

      - name: ğŸ”’ Validate Security Infrastructure
        run: |
          echo "ğŸ” Validation infrastructure sÃ©curisÃ©e..."
          
          # API non accessible directement
          if curl -f -m 5 http://${{ secrets.CANARY_HOST }}:3000/ 2>/dev/null; then
            echo "âŒ ERREUR: API accessible publiquement sur port 3000!"
            exit 1
          else
            echo "âœ… OK: API non accessible publiquement"
          fi
          
          # BDD non accessible directement
          if nc -z -v -w5 ${{ secrets.CANARY_HOST }} 3306 2>/dev/null; then
            echo "âŒ ERREUR: Base de donnÃ©es accessible publiquement!"
            exit 1
          else
            echo "âœ… OK: Base de donnÃ©es non accessible publiquement"
          fi

      - name: ğŸ¯ Validate Application Functions
        run: |
          echo "ğŸ§ª Tests fonctionnels de base..."
          
          # Frontend accessible
          if curl -f -m 10 http://${{ secrets.CANARY_HOST }}/; then
            echo "âœ… Frontend accessible"
          else
            echo "âŒ Frontend non accessible"
            exit 1
          fi
          
  Deploy_Summary:
    name: ğŸ“‹ Deployment Summary
    needs: [Deploy_Canary, Infrastructure_Validation]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“Š RÃ©sumÃ© DÃ©ploiement Canary
        run: |
          echo "ğŸ¯ DÃ‰PLOIEMENT CANARY - RÃ©sumÃ©:"
          echo "  ğŸ“¦ DÃ©ploiement: ${{ needs.Deploy_Canary.result }}"
          echo "  ğŸ”§ Validation Infra: ${{ needs.Infrastructure_Validation.result }}"
          echo ""
          echo "ğŸ“‹ Images dÃ©ployÃ©es:"
          echo "  ğŸ”— API: ${{ needs.Deploy_Canary.outputs.api_image }}"
          echo "  ğŸ¨ Frontend: ${{ needs.Deploy_Canary.outputs.frontend_image }}"
          echo "  ğŸ“Œ SHA: ${{ needs.Deploy_Canary.outputs.deployed_sha }}"
          
          if [[ "${{ needs.Deploy_Canary.result }}" == "success" && 
                "${{ needs.Infrastructure_Validation.result }}" == "success" ]]; then
            echo ""
            echo "âœ… DÃ‰PLOIEMENT CANARY RÃ‰USSI!"
            echo "ğŸš€ Environnement canary opÃ©rationnel"
            echo "ğŸ” PrÃªt pour merge et scan sÃ©curitÃ© complet"
          else
            echo ""
            echo "âŒ DÃ‰PLOIEMENT CANARY Ã‰CHOUÃ‰"
            echo "ğŸ”§ Corriger les problÃ¨mes avant de merger"
            exit 1
          fi